{"version":3,"sources":["../../src/bootstrap/resolve-module-exports.js"],"names":["fs","require","traverse","default","get","babelParseToAst","report","module","exports","modulePath","resolver","resolve","absPath","exportNames","err","code","readFileSync","ast","isCommonJS","isES6","ImportDeclaration","astPath","ExportNamedDeclaration","exportName","push","AssignmentExpression","nodeLeft","node","left","type","property","name","process","env","NODE_ENV","panic"],"mappings":";;AACA,MAAMA,EAAE,GAAGC,OAAO,CAAE,IAAF,CAAlB;;AACA,MAAMC,QAAQ,GAAGD,OAAO,CAAE,gBAAF,CAAP,CAA0BE,OAA3C;;AACA,MAAMC,GAAG,GAAGH,OAAO,CAAE,YAAF,CAAnB;;iBAC4BA,OAAO,CAAE,6BAAF,C;MAA3BI,e,YAAAA,e;;AACR,MAAMC,MAAM,GAAGL,OAAO,CAAE,yBAAF,CAAtB;AAEA;;;;;;;;;;;AASAM,MAAM,CAACC,OAAP,GAAiB,CAACC,UAAD,EAAaC,QAAQ,GAAGT,OAAO,CAACU,OAAhC,KAA4C;AAC3D,MAAIC,OAAJ;AACA,QAAMC,WAAW,GAAG,EAApB;;AAEA,MAAI;AACFD,IAAAA,OAAO,GAAGF,QAAQ,CAACD,UAAD,CAAlB;AACD,GAFD,CAEE,OAAOK,GAAP,EAAY;AACZ,WAAOD,WAAP,CADY,CACO;AACpB;;AACD,QAAME,IAAI,GAAGf,EAAE,CAACgB,YAAH,CAAgBJ,OAAhB,EAA0B,MAA1B,CAAb,CAT2D,CASb;;AAE9C,QAAMK,GAAG,GAAGZ,eAAe,CAACU,IAAD,EAAOH,OAAP,CAA3B;AAEA,MAAIM,UAAU,GAAG,KAAjB;AACA,MAAIC,KAAK,GAAG,KAAZ,CAd2D,CAgB3D;;AACAjB,EAAAA,QAAQ,CAACe,GAAD,EAAM;AACZ;AACAG,IAAAA,iBAAiB,EAAE,SAASA,iBAAT,CAA2BC,OAA3B,EAAoC;AACrDF,MAAAA,KAAK,GAAG,IAAR;AACD,KAJW;AAMZ;AACAG,IAAAA,sBAAsB,EAAE,SAASA,sBAAT,CAAgCD,OAAhC,EAAyC;AAC/D,YAAME,UAAU,GAAGnB,GAAG,CACpBiB,OADoB,EAEnB,0CAFmB,CAAtB;AAIAF,MAAAA,KAAK,GAAG,IAAR;AACA,UAAII,UAAJ,EAAgBV,WAAW,CAACW,IAAZ,CAAiBD,UAAjB;AACjB,KAdW;AAeZE,IAAAA,oBAAoB,EAAE,SAASA,oBAAT,CAA8BJ,OAA9B,EAAuC;AAC3D,YAAMK,QAAQ,GAAGL,OAAO,CAACM,IAAR,CAAaC,IAA9B;AAEA,UAAIF,QAAQ,CAACG,IAAT,KAAmB,kBAAvB,EAA0C,OAHiB,CAK3D;;AACA,UAAIzB,GAAG,CAACsB,QAAD,EAAY,aAAZ,CAAH,KAAkC,SAAtC,EAAgD;AAC9CR,QAAAA,UAAU,GAAG,IAAb;AACAL,QAAAA,WAAW,CAACW,IAAZ,CAAiBE,QAAQ,CAACI,QAAT,CAAkBC,IAAnC;AACD,OAT0D,CAW3D;;;AACA,UACE3B,GAAG,CAACsB,QAAD,EAAY,oBAAZ,CAAH,KAAyC,QAAzC,IACAtB,GAAG,CAACsB,QAAD,EAAY,sBAAZ,CAAH,KAA2C,SAF7C,EAGE;AACAR,QAAAA,UAAU,GAAG,IAAb;AACAL,QAAAA,WAAW,CAACW,IAAZ,CAAiBE,QAAQ,CAACI,QAAT,CAAkBC,IAAnC;AACD;AACF;AAlCW,GAAN,CAAR;;AAqCA,MAAIZ,KAAK,IAAID,UAAT,IAAuBc,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAA0B,MAArD,EAA4D;AAC1D5B,IAAAA,MAAM,CAAC6B,KAAP,CACG;;;UAGG1B,UAAW;;;;OAJjB;AAUD;;AACD,SAAOI,WAAP;AACD,CAnED","sourcesContent":["// @flow\nconst fs = require(`fs`)\nconst traverse = require(`babel-traverse`).default\nconst get = require(`lodash/get`)\nconst { babelParseToAst } = require(`../utils/babel-parse-to-ast`)\nconst report = require(`gatsby-cli/lib/reporter`)\n\n/**\n * Given a `require.resolve()` compatible path pointing to a JS module,\n * return an array listing the names of the module's exports.\n *\n * Returns [] for invalid paths and modules without exports.\n *\n * @param {string} modulePath\n * @param {function} resolver\n */\nmodule.exports = (modulePath, resolver = require.resolve) => {\n  let absPath\n  const exportNames = []\n\n  try {\n    absPath = resolver(modulePath)\n  } catch (err) {\n    return exportNames // doesn't exist\n  }\n  const code = fs.readFileSync(absPath, `utf8`) // get file contents\n\n  const ast = babelParseToAst(code, absPath)\n\n  let isCommonJS = false\n  let isES6 = false\n\n  // extract names of exports from file\n  traverse(ast, {\n    // Check if the file is using ES6 imports\n    ImportDeclaration: function ImportDeclaration(astPath) {\n      isES6 = true\n    },\n\n    // get foo from `export const foo = bar`\n    ExportNamedDeclaration: function ExportNamedDeclaration(astPath) {\n      const exportName = get(\n        astPath,\n        `node.declaration.declarations[0].id.name`\n      )\n      isES6 = true\n      if (exportName) exportNames.push(exportName)\n    },\n    AssignmentExpression: function AssignmentExpression(astPath) {\n      const nodeLeft = astPath.node.left\n\n      if (nodeLeft.type !== `MemberExpression`) return\n\n      // get foo from `exports.foo = bar`\n      if (get(nodeLeft, `object.name`) === `exports`) {\n        isCommonJS = true\n        exportNames.push(nodeLeft.property.name)\n      }\n\n      // get foo from `module.exports.foo = bar`\n      if (\n        get(nodeLeft, `object.object.name`) === `module` &&\n        get(nodeLeft, `object.property.name`) === `exports`\n      ) {\n        isCommonJS = true\n        exportNames.push(nodeLeft.property.name)\n      }\n    },\n  })\n\n  if (isES6 && isCommonJS && process.env.NODE_ENV !== `test`) {\n    report.panic(\n      `This plugin file is using both CommonJS and ES6 module systems together which we don't support.\nYou'll need to edit the file to use just one or the other.\n\nplugin: ${modulePath}.js\n\nThis didn't cause a problem in Gatsby v1 so you might want to review the migration doc for this:\nhttps://gatsby.app/no-mixed-modules\n      `\n    )\n  }\n  return exportNames\n}\n"],"file":"resolve-module-exports.js"}